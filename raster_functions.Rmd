---
title: "Functionalizing NEON Rasters"
author: "Enrique Monta&ntilde;o"
date: "June 21, 2016"
output: html_document
---

## Objectives

Objectives/tasks to work though:

1. Import a raster — A lidar canopy height model (lidar/Teak_lidarCHM.tif)
1. For the CHM, set values == 0 to NA (not trees)
1. Classify the raster according to some distribution – low medium and tall trees. This could be done using a histogram potentially or we could just decide that <2m is generally grasses / understory, <6m small trees,and the rest are tall trees. A function could import the desired thresholds. Visualize density and plot vertical cutoff lines.
1. Plot the classified raster, add a legend for each “class” - legends are super tricky to simplifying this process with a function would be good.  see: http://neon-workwithdata.github.io/neon-data-institute-2016/R/classify-by-threshold-R/  for my take on forcing a legend outside of the plot area using par settings. You may have other better forms of magic to make this work well. :)
1. Export the plot figure to a pdf – publishable
1. Export the classified raster as a geotiff with NaFlagg = -9999 to an outputs folder.

## Load Libraries
```{r load-libraries}
library(raster)
library(rgdal)
library(rhdf5)

```

## Import CHM Raster

```{r import-chm}
# import the raster
chm <- raster("../NEONdata/D17-California/TEAK/2013/lidar/TEAK_lidarCHM.tif")

# set no data values; trees are > 0
chm[chm == 0] <- NA

```

## Plot a histogram

A historgram helps identify thresholds

```{r chm-hist}
# Plot a histogram
hist(chm,
     main = "Histogram of Teakettle Site CHM",
     xlab = "Height (m)")

```

## Determine Thresholds

Common sense suggests heights less than 2m is understory.  The histogram indicates most of the trees are between 5 and ~30m. Small trees that are not necessarily understory seem to fall at the 10m to 20m;  The rest are bigger

## Classify the raster

```{r classify-chm}

# create a vector of threshold values
class_m <- c(-1, 2, NA,
           2, 6, 1,
           6, 20, 2,
           20, 100, 3)

# make it a matrix
rcl_m <- matrix(class_m,
                   ncol = 3,
                   byrow = TRUE)

# plot a new density and include cutoffs
density(chm,
     main = "Density of Teakettle Site CHM",
     xlab = "Height (m)")

# add in threshold values
abline(v=rcl_m[,2], col = "red")


# save as pdf
pdf(file = "TEAK_CHM_density_with_breaks.pdf", width = 6, height = 7)

# plot a new density and include cutoffs
density(chm,
     main = "Density of Teakettle Site CHM",
     xlab = "Height (m)")

# add in threshold values
abline(v=rcl_m[,2], col = "red")

dev.off()

# Perform the reclass
chm_rcl <- reclassify(chm,
                      rcl_m)

# plot the result
# make room for a legend
par(xpd = FALSE, mar=c(5.1, 4.1, 4.1, 4.5))

# plot
plot(chm_rcl,
     col=c("red","blue","green"), # hard code colors, unclassified (0)=white,
		 #N (1) =blue, S(2)=green
     main="Tree Heights for\nLower Teakettle Site",
		 xlab = "Lat (UTM)",
		 ylab = "Lon (UTM)",
     legend=F)
# allow legend to plot outside of bounds
par(xpd=TRUE)
# create the legend
# legend x position
leg_x <- par()$usr[2] + 20

# legend y position
leg_y <- par()$usr[4] + 50 - (abs(par()$usr[3] - par()$usr[4]) / 2)

legend(leg_x, leg_y,  # set x,y legend location
       legend = c("6-10m", "10-20m", ">20m"),  # make sure the order matches the colors, next
       fill = c("red", "blue", "green"),
       bty="n") # turn off border



pdf(file = "TEAK_classified_tree_heights.pdf", width = 7, height = 6)

# plot
plot(chm_rcl,
     col=c("red","blue","green"), # hard code colors, unclassified (0)=white,
		 #N (1) =blue, S(2)=green
     main="Tree Heights for\nLower Teakettle Site",
		 xlab = "Lat (UTM)",
		 ylab = "Lon (UTM)",
     legend=F)
# allow legend to plot outside of bounds
par(xpd=TRUE)
# create the legend
# legend x position
leg_x <- par()$usr[2] + 20

# legend y position
leg_y <- par()$usr[4] + 50 - (abs(par()$usr[3] - par()$usr[4]) / 2)

legend(leg_x, leg_y,  # set x,y legend location
       legend = c("6-10m", "10-20m", ">20m"),  # make sure the order matches the colors, next
       fill = c("red", "blue", "green"),
       bty="n") # turn off border

dev.off()

```

## Export the result

```{r export-chm}
# export geotiff
writeRaster(chm_rcl,
            filename="reclassify_Teak_chm.tif",
            format="GTiff",
            options="COMPRESS=LZW",
            overwrite = TRUE,
            NAflag = -9999)

```

## Document the environment

```{r doc-logfile}
sink(paste0(format(Sys.time(), "%y-%m-%d:%H%M%S"),
     "_sessionInfo.txt"))
sessionInfo()
sink()
```




